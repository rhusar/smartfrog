#!/bin/sh

###### Definitions


# Prints a message, the usage message, and exits. Arguments:
# $1: Message string, required.
# $2: Exit value (default: 69)
usage() {
    echo "$1"
    cat<<END
Usage:  $0 -h|--help
        $0 -t|--target targethost [-e|--environment env_description_URL.sf [env_description_URL.sf...]]
        -a|--application [AppName] description_URL.sf [-a|--application [AppName] description_URL.sf...]
END
    if [ ! -z $2 ]; then
        exit $2
    else
        exit 69
    fi
}

# Escapes spaces in the argument
add_backslashes () {
    echo "$1" | sed -e 's/ /\\ /g'
}

# Check if argument is valid (non-empty and not an option switch).
invalid() {
    [ -z "$1" ] || (echo "$1" | grep -q '^-')
}

valid() {
    if invalid "$1"; then false;
    else true
    fi
}

###### Start of main script

## Setting SFHOME
if [ -z "$SFHOME" -o ! -d "$SFHOME" ] ; then
    SFHOME=`dirname "$0"`/..
    SFHOME=`cd "$SFHOME" && pwd`
    export SFHOME
    echo "SFHOME undefined, using $SFHOME as base directory."
fi

## Include setSFProperties
. "$SFHOME/bin/setSFProperties"

## Process command line arguments.
APPSCRIPTS=

while [ ! -z $1 ]; do
    case "$1" in
        -h | --help)
            usage "This script is used to start a new SmartFrog application on a running daemon. It allows the use of an arbitrary number of parser setup descriptions, followed by an arbitrary number of descriptions for the application itself." 0
            ;;

        -t | --target)
            if invalid "$2"; then
                usage "Missing target hostname after --target option."
            fi
            TARGETHOST="$2"
            shift
            ;;

        -a | --application)
            if invalid "$2"; then
                usage "Missing application description after --application option."
            fi
            
            if invalid "$3"; then
                # No name given for this description
                APPSCRIPTS="$APPSCRIPTS -a :DEPLOY:\"$2\"::\"__TARGETHOST__\":"
                shift
            else
                # Using a name
                APPSCRIPTS="$APPSCRIPTS -a \"$2\":DEPLOY:\"$3\"::\"__TARGETHOST__\":"            
                shift 2
            fi
            ;;

        -p | --parser)
            ENVSCRIPTS=
            i=1
            while valid "$2"; do
                ENVSCRIPTS="$ENVSCRIPTS "" -Dorg.smartfrog.sfcore.processcompound.sfDefault.parserEnv""$i"=`add_backslashes "$2"`
                i=`expr $i + 1`
                shift
            done
            if [ -z "$ENVSCRIPTS" ]; then
                usage "At least one environment description is needed if the -e option is used."
            fi
            ;;

        *)
            usage "Unrecognized argument: $1"
            ;;
    esac

    shift
done

## Post-parse checks
if [ -z "$TARGETHOST" ]; then usage "Missing deployment target host name"; fi
if [ -z "$APPSCRIPTS" ]; then usage "At least one application description is needed"; fi

## Replace placeholder values
APPSCRIPTS=`echo "$APPSCRIPTS" | sed s/__TARGETHOST__/"$TARGETHOST"/g`

## Finally, run SmartFrog with the parsed arguments.
if test "$SFSECURITY"; then
        java $ENVSCRIPTS $SFSECURITY "$SFDEFAULTINI" org.smartfrog.SFSystem $APPSCRIPTS -e
else
        java $ENVSCRIPTS "$SFDEFAULTINI" org.smartfrog.SFSystem $APPSCRIPTS -e
fi
